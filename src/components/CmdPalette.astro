---
// Lightweight Command Palette using Fuse.js
import { onMount } from 'astro/jsx-runtime';
const modules = import.meta.glob('../../content/blog/*.{md,mdx}', { eager: true });
const posts = Object.entries(modules).map(([path, mod]) => {
  const slug = path.split('/').pop().replace(/\.(md|mdx)$/, '');
  const fm = (mod as any).frontmatter || {};
  return { title: fm.title || slug, slug, description: fm.description || '' };
});
---

<div id="cmd-palette" class="cmd-palette" style="display:none;">
  <input id="cmd-input" placeholder="Search posts..." class="cmd-input" />
  <ul id="cmd-results" class="cmd-results"></ul>
</div>

<script is:inline type="module">
  import Fuse from 'fuse.js';
  const data = JSON.parse(decodeURIComponent("{{ encodeURIComponent(JSON.stringify(posts)) }}"));
  const fuse = new Fuse(data, { keys: ['title', 'description'], threshold: 0.35 });

  const palette = document.getElementById('cmd-palette');
  const input = document.getElementById('cmd-input');
  const results = document.getElementById('cmd-results');

  const openPalette = () => {
    palette.style.display = 'block';
    input.focus();
  };
  const closePalette = () => {
    palette.style.display = 'none';
    input.value = '';
    results.innerHTML = '';
  };

  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
      e.preventDefault();
      openPalette();
    }
    if (e.key === 'Escape') closePalette();
  });

  input.addEventListener('input', () => {
    results.innerHTML = '';
    const q = input.value.trim();
    if (!q) return;
    const res = fuse.search(q).slice(0, 8);
    res.forEach(r => {
      const li = document.createElement('li');
      li.innerHTML = `<a href="/blog/${r.item.slug}" onclick="closePalette()">${r.item.title}<div class="text-sm text-neutral-500">${r.item.description || ''}</div></a>`;
      results.appendChild(li);
    });
  });
</script>

<style is:global>
  .cmd-palette { position: fixed; left:50%; transform: translateX(-50%); top:12%; width: min(900px, 92%); z-index: 80; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
  .cmd-input { width:100%; padding:12px; font-size:1rem; border:none; outline:none; }
  .cmd-results li { list-style:none; padding:8px 10px; border-radius:6px; }
  .cmd-results li a { color:inherit; text-decoration:none; display:block; }
  .cmd-results li:hover { background: rgba(0,0,0,0.03); }
  @media (prefers-color-scheme: dark) {
    .cmd-palette { background: #111; color: #f1f1f1; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
  }
</style>
